server {
    listen 80 default_server;

    root /usr/share/nginx/html;
    index index.html;

    #todo: enable cache
    #todo: 404 page

    server_name localhost;

    set $mobileRegex "(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od|ad)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino";

    #static resources
    location ~ ^/static/(.*) {
        try_files $uri $uri/ =404;
    }

    #mobile url
    location ~ ^/(cn|vn|th)/mobile {
        try_files $uri $uri/ =404;
    }

    #without mobile
    location ~ ^/(cn|vn|th)/(?!mobile).* {
        #isfile exist
        if (-f $request_filename)
        {
            try_files $uri $uri/ =404;
        }

        #isMobile
        if ($http_user_agent ~* $mobileRegex) {
            rewrite  ^/(cn|vn|th)/(.*)$  /$1/mobile/$2 permanent;
            break;
        }

        #pc
        try_files $uri $uri/ =404;
    }

    #others(no language or language incorrect)
    location / {
        #isfile exist
        if (-f $request_filename)
        {
            try_files $uri $uri/ =404;
        }

        #mapping language folder
        map $http_accept_language $lang {
            default cn;
            ~zh cn;
            ~cn cn;
            ~vi vn;
            ~vn vn;
            ~th th;
        }

        #isMobile
        if ($http_user_agent ~* $mobileRegex) {
            rewrite  ^/(.*)$  /$lang/mobile/$2 permanent;
            break;
        }

        rewrite  ^/(.*)$  /$lang/$2 permanent;
    }
}
